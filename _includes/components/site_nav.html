{%- comment -%} 
Override Just the Docs components/site_nav.html with language filtering
This file is called by sidebar.html (or default layout) to generate navigation

问题：page.url 在 includes 中不可靠（显示 /404.html），必须使用客户端检测
解决方案：使用客户端 JavaScript 检测语言并过滤导航
{%- endcomment -%}

{%- comment -%} 先渲染所有页面，由客户端 JavaScript 过滤 {%- endcomment -%}
{% include nav.html pages=site.html_pages key=nil %}

{%- comment -%} 客户端语言检测和过滤 {%- endcomment -%}
<script>
console.log('[site_nav] Script loading');
(function() {
  console.log('[site_nav] Script started');
  
  function getLang(path) {
    if (path.indexOf('/zh-cn/') !== -1) return 'zh-cn';
    if (path.indexOf('/es/') !== -1) return 'es';
    return 'en';
  }
  
  function filterNav() {
    console.log('[site_nav] filterNav called');
    var currentLang = getLang(window.location.pathname);
    console.log('[site_nav] Current lang:', currentLang, 'path:', window.location.pathname);
    
    var items = document.querySelectorAll('.nav-list > .nav-list-item');
    console.log('[site_nav] Found', items.length, 'items');
    
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      var link = item.querySelector('.nav-list-link');
      if (!link) continue;
      
      var href = link.getAttribute('href');
      if (!href || href === '#') continue;
      
      var itemLang = getLang(href);
      if (itemLang !== currentLang) {
        item.style.display = 'none';
      } else {
        var childList = item.querySelector('ul.nav-list');
        if (childList) {
          var childItems = childList.querySelectorAll('.nav-list-item');
          for (var j = 0; j < childItems.length; j++) {
            var childLink = childItems[j].querySelector('.nav-list-link');
            if (childLink) {
              var childHref = childLink.getAttribute('href');
              if (childHref && childHref !== '#') {
                var childLang = getLang(childHref);
                if (childLang !== currentLang) {
                  childItems[j].style.display = 'none';
                }
              }
            }
          }
        }
      }
    }
    
    // 绑定展开按钮点击事件
    var expanders = document.querySelectorAll('.nav-list-expander');
    console.log('[site_nav] Found', expanders.length, 'expanders');
    for (var k = 0; k < expanders.length; k++) {
      var exp = expanders[k];
      exp.addEventListener('click', function(e) {
        console.log('[site_nav] Expander clicked');
        e.preventDefault();
        e.stopPropagation();
        var listItem = e.target.closest('.nav-list-item');
        if (!listItem) return;
        var childList = listItem.querySelector('ul.nav-list');
        if (!childList) return;
        var isHidden = window.getComputedStyle(childList).display === 'none';
        childList.style.display = isHidden ? 'block' : 'none';
        listItem.classList.toggle('active', isHidden);
        console.log('[site_nav] Toggled, display:', childList.style.display);
      });
    }
  }
  
  function init() {
    console.log('[site_nav] init called');
    setTimeout(function() {
      console.log('[site_nav] setTimeout executed');
      filterNav();
    }, 300);
  }
  
  if (document.readyState === 'loading') {
    console.log('[site_nav] Waiting for DOMContentLoaded');
    document.addEventListener('DOMContentLoaded', init);
  } else {
    console.log('[site_nav] Document ready, calling init');
    init();
  }
})();
</script>

