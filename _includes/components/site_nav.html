{%- comment -%} 
Override Just the Docs components/site_nav.html with language filtering
This file is called by sidebar.html (or default layout) to generate navigation

问题：page.url 在 includes 中不可靠（显示 /404.html），必须使用客户端检测
解决方案：使用客户端 JavaScript 检测语言并过滤导航
{%- endcomment -%}

{%- comment -%} 先渲染所有页面，由客户端 JavaScript 过滤 {%- endcomment -%}
{% include nav.html pages=site.html_pages key=nil %}

{%- comment -%} 客户端语言检测和过滤 {%- endcomment -%}
<script>
(function() {
  console.log('[site_nav] Script started');
  
  function getLang(path) {
    if (path.indexOf('/zh-cn/') !== -1) return 'zh-cn';
    if (path.indexOf('/es/') !== -1) return 'es';
    return 'en';
  }
  
  function filterNav() {
    console.log('[site_nav] filterNav called');
    var currentLang = getLang(window.location.pathname);
    console.log('[site_nav] Current lang:', currentLang, 'from path:', window.location.pathname);
    
    var items = document.querySelectorAll('.nav-list > .nav-list-item');
    console.log('[site_nav] Found', items.length, 'top-level nav items');
    
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      var link = item.querySelector('.nav-list-link');
      if (!link) {
        console.log('[site_nav] Item', i, 'has no nav-list-link');
        continue;
      }
      
      var href = link.getAttribute('href');
      if (!href || href === '#') {
        console.log('[site_nav] Item', i, 'has no href or href is #');
        continue;
      }
      
      var itemLang = getLang(href);
      console.log('[site_nav] Item', i, 'lang:', itemLang, 'href:', href);
      
      if (itemLang !== currentLang) {
        console.log('[site_nav] Hiding item', i, 'lang mismatch');
        item.style.display = 'none';
      } else {
        var expander = item.querySelector('.nav-list-expander');
        if (expander) {
          console.log('[site_nav] Item', i, 'has expander button');
        }
        
        var childList = item.querySelector('ul.nav-list');
        if (childList) {
          console.log('[site_nav] Item', i, 'has child list, display:', childList.style.display);
          var childItems = childList.querySelectorAll('.nav-list-item');
          console.log('[site_nav] Item', i, 'has', childItems.length, 'children');
          for (var j = 0; j < childItems.length; j++) {
            var childLink = childItems[j].querySelector('.nav-list-link');
            if (childLink) {
              var childHref = childLink.getAttribute('href');
              if (childHref && childHref !== '#') {
                var childLang = getLang(childHref);
                if (childLang !== currentLang) {
                  console.log('[site_nav] Hiding child', j, 'of item', i, 'lang mismatch');
                  childItems[j].style.display = 'none';
                }
              }
            }
          }
        }
      }
    }
    
    // 检查展开按钮和事件绑定
    var expanders = document.querySelectorAll('.nav-list-expander');
    console.log('[site_nav] Found', expanders.length, 'expander buttons after filtering');
    
    for (var k = 0; k < expanders.length; k++) {
      var exp = expanders[k];
      var listItem = exp.closest('.nav-list-item');
      var childList = listItem ? listItem.querySelector('ul.nav-list') : null;
      
      console.log('[site_nav] Expander', k, 'href:', exp.getAttribute('href'));
      console.log('[site_nav] Expander', k, 'parent item:', listItem ? listItem.className : 'none');
      console.log('[site_nav] Expander', k, 'child list:', childList ? 'found' : 'not found');
      if (childList) {
        console.log('[site_nav] Expander', k, 'child list display:', childList.style.display || 'default');
        console.log('[site_nav] Expander', k, 'child list computed display:', window.getComputedStyle(childList).display);
      }
      
      // 检查是否有事件监听器（通过检查是否有onclick属性）
      var onclick = exp.getAttribute('onclick');
      if (onclick) {
        console.log('[site_nav] Expander', k, 'has onclick:', onclick);
      } else {
        console.log('[site_nav] Expander', k, 'no onclick attribute (relying on theme JS)');
      }
      
      // 手动绑定事件来测试（作为备用方案）
      exp.addEventListener('click', function(e) {
        console.log('[site_nav] Expander clicked!', e.target);
        e.preventDefault();
        e.stopPropagation();
        
        var clickedListItem = e.target.closest('.nav-list-item');
        if (!clickedListItem) {
          console.log('[site_nav] No list item found for clicked expander');
          return;
        }
        
        var clickedChildList = clickedListItem.querySelector('ul.nav-list');
        if (!clickedChildList) {
          console.log('[site_nav] No child list found for clicked expander');
          return;
        }
        
        var currentDisplay = window.getComputedStyle(clickedChildList).display;
        console.log('[site_nav] Current computed display:', currentDisplay);
        var isHidden = currentDisplay === 'none';
        console.log('[site_nav] Is hidden:', isHidden);
        
        clickedChildList.style.display = isHidden ? 'block' : 'none';
        clickedListItem.classList.toggle('active', isHidden);
        
        var newDisplay = window.getComputedStyle(clickedChildList).display;
        console.log('[site_nav] After toggle, new display:', newDisplay);
        console.log('[site_nav] List item active class:', clickedListItem.classList.contains('active'));
      });
    }
    
    // 检查主题的JavaScript是否加载（Just-the-Docs可能使用事件委托）
    console.log('[site_nav] Checking for theme JavaScript...');
    var siteNav = document.getElementById('site-nav');
    if (siteNav) {
      console.log('[site_nav] Site nav element found:', siteNav);
      // 检查是否有事件监听器（无法直接检查，但可以测试点击）
    } else {
      console.log('[site_nav] Site nav element not found!');
    }
  }
  
  function init() {
    console.log('[site_nav] init called, readyState:', document.readyState);
    setTimeout(function() {
      console.log('[site_nav] setTimeout callback executed');
      filterNav();
    }, 300);
  }
  
  if (document.readyState === 'loading') {
    console.log('[site_nav] Document loading, waiting for DOMContentLoaded');
    document.addEventListener('DOMContentLoaded', init);
  } else {
    console.log('[site_nav] Document already loaded, calling init immediately');
    init();
  }
})();
</script>

