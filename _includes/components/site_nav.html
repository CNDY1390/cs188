{%- comment -%} 
Override Just the Docs components/site_nav.html with language filtering
This file is called by sidebar.html (or default layout) to generate navigation

问题：page.url 在 includes 中不可靠（显示 /404.html），必须使用客户端检测
解决方案：使用客户端 JavaScript 检测语言并过滤导航
{%- endcomment -%}

{%- comment -%} 先渲染所有页面，由客户端 JavaScript 过滤 {%- endcomment -%}
{% include nav.html pages=site.html_pages key=nil %}

{%- comment -%} 客户端语言检测和过滤 {%- endcomment -%}
<script>
(function() {
  function filterNavByLanguage() {
    var pathname = window.location.pathname;
    var currentLang = 'en';
    if (pathname.includes('/zh-cn/')) {
      currentLang = 'zh-cn';
    } else if (pathname.includes('/es/')) {
      currentLang = 'es';
    }
    
    function getItemLang(href) {
      if (!href || href === '#') return null;
      if (href.includes('/zh-cn/')) return 'zh-cn';
      if (href.includes('/es/')) return 'es';
      return 'en';
    }
    
    function filterItem(item) {
      var link = item.querySelector('.nav-list-link');
      if (!link) return false;
      
      var href = link.getAttribute('href');
      var itemLang = getItemLang(href);
      
      if (itemLang === null) {
        var childList = item.querySelector('ul.nav-list');
        if (childList) {
          var childItems = childList.querySelectorAll('.nav-list-item');
          var hasVisibleChild = false;
          childItems.forEach(function(childItem) {
            if (filterItem(childItem)) {
              hasVisibleChild = true;
            }
          });
          return hasVisibleChild;
        }
        return true;
      }
      
      if (itemLang !== currentLang) {
        return false;
      }
      
      var childList = item.querySelector('ul.nav-list');
      if (childList) {
        var childItems = childList.querySelectorAll('.nav-list-item');
        childItems.forEach(function(childItem) {
          if (!filterItem(childItem)) {
            childItem.style.display = 'none';
          }
        });
      }
      
      return true;
    }
    
    var navItems = document.querySelectorAll('.nav-list > .nav-list-item');
    navItems.forEach(function(item) {
      if (!filterItem(item)) {
        item.style.display = 'none';
      }
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', filterNavByLanguage);
  } else {
    setTimeout(filterNavByLanguage, 100);
  }
})();
</script>

