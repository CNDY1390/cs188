{%- comment -%} 
Custom children_nav.html with language filtering
Override the default Just the Docs children_nav.html to filter by language

问题：page.url 在 includes 中不可靠，必须使用客户端过滤
解决方案：先渲染所有子页面，由客户端 JavaScript 过滤
{%- endcomment -%}

{%- if page.has_children == false or page.has_toc == false -%}
  {%- assign nav_children = "" | split: "" -%}
{%- else -%}
  {%- comment -%} Get all pages and filter by parent (language filtering done by client) {%- endcomment -%}
  {%- assign all_pages = site[page.collection] | default: site.html_pages | where_exp: "item", "item.title != nil" -%}
  {%- comment -%} Group pages by parent {%- endcomment -%}
  {%- assign nav_parenthood = all_pages | group_by: "parent" -%}
  {%- assign nav_parent_group = nav_parenthood | where_exp: "item", "item.name == page.title" | first -%}
  {%- if nav_parent_group -%}
    {%- assign nav_children = nav_parent_group.items -%}
  {%- else -%}
    {%- assign nav_children = "" | split: "" -%}
  {%- endif -%}
{%- endif -%}

{%- if nav_children.size >= 1 -%}
  {%- if page.child_nav_order == 'desc' or page.child_nav_order == 'reversed' -%}
    {%- assign nav_children = nav_children | reverse -%}
  {%- endif -%}

* * *

{% for nav_child in nav_children %}*   [{{ nav_child.title }}]({{ nav_child.url | relative_url }}){% if nav_child.summary %} - {{ nav_child.summary }}{% endif %}
{% endfor %}

{%- comment -%} 客户端语言过滤：在子页面列表中过滤 {%- endcomment -%}
<script>
(function() {
  function getLangFromPath(path) {
    if (path.indexOf('/zh-cn/') !== -1) return 'zh-cn';
    if (path.indexOf('/es/') !== -1) return 'es';
    return 'en';
  }
  
  function filterChildrenNav() {
    var pathname = window.location.pathname;
    var currentLang = getLangFromPath(pathname);
    
    var hrElements = document.querySelectorAll('hr');
    var targetList = null;
    for (var i = 0; i < hrElements.length; i++) {
      var nextSibling = hrElements[i].nextElementSibling;
      while (nextSibling) {
        if (nextSibling.tagName === 'UL') {
          targetList = nextSibling;
          break;
        }
        nextSibling = nextSibling.nextElementSibling;
      }
      if (targetList) break;
    }
    
    if (!targetList) return;
    
    var links = targetList.querySelectorAll('a');
    for (var i = 0; i < links.length; i++) {
      var link = links[i];
      var href = link.getAttribute('href');
      if (!href) continue;
      
      var itemLang = getLangFromPath(href);
      if (itemLang !== currentLang) {
        var listItem = link.closest('li');
        if (listItem) {
          listItem.style.display = 'none';
        }
      }
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', filterChildrenNav);
  } else {
    setTimeout(filterChildrenNav, 100);
  }
})();
</script>

{%- endif -%}

