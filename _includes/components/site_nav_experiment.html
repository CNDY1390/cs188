{%- comment -%} 
实验文件：逐个验证多语言过滤问题
实验1：验证 page.url 检测
实验2：验证 item.lang 设置
实验3：验证过滤逻辑
{%- endcomment -%}

{%- comment -%} ========== 实验1：验证 page.url 检测 ========== {%- endcomment -%}
<script>
console.log('=== 实验1：page.url 检测 ===');
console.log('page.url:', {{ page.url | jsonify }});
console.log('page.path:', {{ page.path | jsonify }});
console.log('page.lang:', {{ page.lang | jsonify }});
console.log('window.location.pathname:', window.location.pathname);
</script>

{%- comment -%} 检测逻辑 {%- endcomment -%}
{%- assign exp1_url_contains_zh_cn = false -%}
{%- assign exp1_url_contains_es = false -%}
{%- if page.url contains "/zh-cn/" -%}
  {%- assign exp1_url_contains_zh_cn = true -%}
{%- endif -%}
{%- if page.url contains "/es/" -%}
  {%- assign exp1_url_contains_es = true -%}
{%- endif -%}

<script>
console.log('page.url contains "/zh-cn/":', {{ exp1_url_contains_zh_cn | jsonify }});
console.log('page.url contains "/es/":', {{ exp1_url_contains_es | jsonify }});
console.log('window.location.pathname contains "/zh-cn/":', window.location.pathname.includes('/zh-cn/'));
console.log('window.location.pathname contains "/es/":', window.location.pathname.includes('/es/'));
</script>

{%- comment -%} ========== 实验2：验证 item.lang 设置 ========== {%- endcomment -%}
<script>
console.log('=== 实验2：item.lang 设置 ===');
console.log('site.html_pages 总数:', {{ site.html_pages | size }});
</script>

{%- assign exp2_en_count = 0 -%}
{%- assign exp2_zh_cn_count = 0 -%}
{%- assign exp2_es_count = 0 -%}
{%- assign exp2_nil_count = 0 -%}
{%- assign exp2_empty_count = 0 -%}
{%- assign exp2_path_zh_cn_count = 0 -%}
{%- assign exp2_path_es_count = 0 -%}

{%- for item in site.html_pages -%}
  {%- if item.lang == nil -%}
    {%- assign exp2_nil_count = exp2_nil_count | plus: 1 -%}
  {%- elsif item.lang == "" -%}
    {%- assign exp2_empty_count = exp2_empty_count | plus: 1 -%}
  {%- elsif item.lang == "en" -%}
    {%- assign exp2_en_count = exp2_en_count | plus: 1 -%}
  {%- elsif item.lang == "zh-cn" -%}
    {%- assign exp2_zh_cn_count = exp2_zh_cn_count | plus: 1 -%}
  {%- elsif item.lang == "es" -%}
    {%- assign exp2_es_count = exp2_es_count | plus: 1 -%}
  {%- endif -%}
  {%- if item.path contains "zh-cn/" -%}
    {%- assign exp2_path_zh_cn_count = exp2_path_zh_cn_count | plus: 1 -%}
  {%- endif -%}
  {%- if item.path contains "es/" -%}
    {%- assign exp2_path_es_count = exp2_path_es_count | plus: 1 -%}
  {%- endif -%}
{%- endfor -%}

<script>
console.log('item.lang == "en":', {{ exp2_en_count }});
console.log('item.lang == "zh-cn":', {{ exp2_zh_cn_count }});
console.log('item.lang == "es":', {{ exp2_es_count }});
console.log('item.lang == nil:', {{ exp2_nil_count }});
console.log('item.lang == "":', {{ exp2_empty_count }});
console.log('item.path contains "zh-cn/":', {{ exp2_path_zh_cn_count }});
console.log('item.path contains "es/":', {{ exp2_path_es_count }});
</script>

{%- comment -%} 详细检查前10个页面 {%- endcomment -%}
{%- assign exp2_sample_count = 0 -%}
{%- for item in site.html_pages limit: 10 -%}
  {%- assign exp2_sample_count = exp2_sample_count | plus: 1 -%}
  <script>
  console.log('样本{{ exp2_sample_count }}: path={{ item.path | jsonify }}, url={{ item.url | jsonify }}, lang={{ item.lang | jsonify }}, title={{ item.title | jsonify }}');
  </script>
{%- endfor -%}

{%- comment -%} ========== 实验3：验证过滤逻辑 ========== {%- endcomment -%}
<script>
console.log('=== 实验3：过滤逻辑 ===');
</script>

{%- comment -%} 当前语言检测 {%- endcomment -%}
{%- assign exp3_current_lang = "en" -%}
{%- if page.url contains "/zh-cn/" -%}
  {%- assign exp3_current_lang = "zh-cn" -%}
{%- elsif page.url contains "/es/" -%}
  {%- assign exp3_current_lang = "es" -%}
{%- elsif page.lang != nil and page.lang != "" -%}
  {%- assign exp3_current_lang = page.lang -%}
{%- endif -%}

<script>
console.log('检测到的当前语言:', {{ exp3_current_lang | jsonify }});
</script>

{%- comment -%} 过滤过程 {%- endcomment -%}
{%- assign exp3_filtered_pages = "" | split: "X" -%}
{%- assign exp3_matched_by_lang = 0 -%}
{%- assign exp3_matched_by_path = 0 -%}
{%- assign exp3_not_matched = 0 -%}

{%- for item in site.html_pages -%}
  {%- assign exp3_item_lang = "en" -%}
  {%- assign exp3_match_method = "none" -%}
  
  {%- if item.lang != nil and item.lang != "" -%}
    {%- assign exp3_item_lang = item.lang -%}
    {%- assign exp3_match_method = "lang" -%}
  {%- elsif item.path contains "zh-cn/" -%}
    {%- assign exp3_item_lang = "zh-cn" -%}
    {%- assign exp3_match_method = "path" -%}
  {%- elsif item.path contains "es/" -%}
    {%- assign exp3_item_lang = "es" -%}
    {%- assign exp3_match_method = "path" -%}
  {%- endif -%}
  
  {%- if exp3_item_lang == exp3_current_lang -%}
    {%- assign exp3_filtered_pages = exp3_filtered_pages | push: item -%}
    {%- if exp3_match_method == "lang" -%}
      {%- assign exp3_matched_by_lang = exp3_matched_by_lang | plus: 1 -%}
    {%- elsif exp3_match_method == "path" -%}
      {%- assign exp3_matched_by_path = exp3_matched_by_path | plus: 1 -%}
    {%- endif -%}
  {%- else -%}
    {%- assign exp3_not_matched = exp3_not_matched | plus: 1 -%}
  {%- endif -%}
{%- endfor -%}

<script>
console.log('过滤结果:');
console.log('  匹配当前语言 (通过 lang):', {{ exp3_matched_by_lang }});
console.log('  匹配当前语言 (通过 path):', {{ exp3_matched_by_path }});
console.log('  不匹配:', {{ exp3_not_matched }});
console.log('  过滤后总数:', {{ exp3_filtered_pages | size }});
</script>

{%- comment -%} 检查过滤后的页面样本 {%- endcomment -%}
{%- assign exp3_sample_count = 0 -%}
{%- for item in exp3_filtered_pages limit: 10 -%}
  {%- assign exp3_sample_count = exp3_sample_count | plus: 1 -%}
  <script>
  console.log('过滤后样本{{ exp3_sample_count }}: path={{ item.path | jsonify }}, url={{ item.url | jsonify }}, lang={{ item.lang | jsonify }}, title={{ item.title | jsonify }}');
  </script>
{%- endfor -%}

{%- comment -%} 检查是否有错误匹配 {%- endcomment -%}
{%- assign exp3_wrong_lang_count = 0 -%}
{%- for item in exp3_filtered_pages -%}
  {%- assign exp3_check_lang = "en" -%}
  {%- if item.lang != nil and item.lang != "" -%}
    {%- assign exp3_check_lang = item.lang -%}
  {%- elsif item.path contains "zh-cn/" -%}
    {%- assign exp3_check_lang = "zh-cn" -%}
  {%- elsif item.path contains "es/" -%}
    {%- assign exp3_check_lang = "es" -%}
  {%- endif -%}
  {%- if exp3_check_lang != exp3_current_lang -%}
    {%- assign exp3_wrong_lang_count = exp3_wrong_lang_count | plus: 1 -%}
    <script>
    console.warn('错误匹配: path={{ item.path | jsonify }}, 检测到语言={{ exp3_check_lang | jsonify }}, 当前语言={{ exp3_current_lang | jsonify }}');
    </script>
  {%- endif -%}
{%- endfor -%}

<script>
if ({{ exp3_wrong_lang_count }} > 0) {
  console.error('发现 {{ exp3_wrong_lang_count }} 个错误匹配的页面！');
} else {
  console.log('✓ 所有过滤后的页面语言都正确');
}
console.log('=== 实验结束 ===');
</script>

