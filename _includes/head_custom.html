<script
  type="text/javascript"
  async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"
></script>
<script>
  // Global function for nav-list-expander clicks - must be defined immediately
  // Use IIFE to ensure it's available before any HTML renders
  (function() {
    window.toggleNavList = function(expander) {
      var listItem = expander.closest('.nav-list-item');
      if (listItem) {
        var childList = listItem.querySelector('ul.nav-list');
        if (childList) {
          if (childList.style.display === 'none' || !childList.style.display) {
            childList.style.display = '';
            listItem.classList.add('active');
          } else {
            childList.style.display = 'none';
            listItem.classList.remove('active');
          }
        }
      }
      return false;
    };
  })();

  let toggleDark = () => {
    console.log('[DEBUG] toggleDark called');
    try {
      if (typeof jtd === 'undefined' || !jtd.getTheme) {
        console.error('[DEBUG] jtd is not defined or getTheme is not available');
        // Fallback: toggle data-theme directly
        let currentTheme = document.documentElement.getAttribute('data-theme');
        let setDark = currentTheme !== 'dark';
        document.documentElement.setAttribute('data-theme', setDark ? 'dark' : 'default');
        localStorage.setItem('darkMode', String(setDark));
        console.log('[DEBUG] Toggled theme to:', setDark ? 'dark' : 'default');
        return;
      }
      let setDark = jtd.getTheme() !== 'dark';
      document.documentElement.setAttribute('data-theme', setDark ? 'dark' : 'default');
      jtd.setTheme(setDark ? 'dark' : 'default');
      localStorage.setItem('darkMode', String(setDark));
      console.log('[DEBUG] Toggled theme to:', setDark ? 'dark' : 'default');
    } catch (e) {
      console.error('[DEBUG] Error in toggleDark:', e);
    }
  };

  window.addEventListener('DOMContentLoaded', () => {
    /* Add event to dark mode button. */
    console.log('[DEBUG] Looking for Dark Mode button...');
    let buttons = document.getElementsByClassName('site-button');
    console.log('[DEBUG] Found', buttons.length, 'site-button elements');
    
    // Log all buttons for debugging
    for (let i = 0; i < buttons.length; i++) {
      let btn = buttons[i];
      console.log('[DEBUG] Button', i, ':', {
        id: btn.id,
        tagName: btn.tagName,
        href: btn.href || btn.getAttribute('href'),
        text: btn.textContent.trim(),
        className: btn.className
      });
    }
    
    // Try original Berkeley method first (buttons[2])
    if (buttons.length > 2) {
      let btn = buttons[2];
      console.log('[DEBUG] Trying buttons[2]:', btn);
      if (btn && btn.tagName === 'A') {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('[DEBUG] Dark Mode button clicked');
          toggleDark();
        });
        console.log('[DEBUG] Dark Mode event listener attached to buttons[2]');
        return;
      }
    }
    
    // Fallback: find by text content
    for (let i = 0; i < buttons.length; i++) {
      let btn = buttons[i];
      if (btn.id === 'menu-button') continue;
      if (btn.tagName === 'A' && btn.textContent.trim() === 'Dark Mode') {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('[DEBUG] Dark Mode button clicked (fallback)');
          toggleDark();
        });
        console.log('[DEBUG] Dark Mode event listener attached (fallback)');
        return;
      }
    }
    
    console.warn('[DEBUG] Dark Mode button not found!');

    /* Read local storage state. */
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.setAttribute('data-theme', 'dark');
      toggleDark();
    } else {
      document.documentElement.setAttribute('data-theme', 'default');
    }

    // Expand active items by default
    var activeItems = document.querySelectorAll('.nav-list-item.active');
    activeItems.forEach(function(item) {
      var parent = item.closest('.nav-list-item.has-children');
      if (parent) {
        var childList = parent.querySelector('ul.nav-list');
        if (childList) {
          childList.style.display = '';
          parent.classList.add('active');
        }
      }
    });
  });
</script>
