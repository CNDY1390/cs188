<!-- Multi-Language Toggle -->
<script type="text/javascript">
// Define toggleLanguageMenu FIRST, before any other code
window.toggleLanguageMenu = function() {
  console.log('toggleLanguageMenu called');
  var menu = document.getElementById('languageMenu');
  console.log('Menu element:', menu);
  if (menu) {
    var isShowing = menu.classList.contains('show');
    console.log('Menu is showing:', isShowing);
    if (isShowing) {
      menu.classList.remove('show');
    } else {
      menu.classList.add('show');
    }
    console.log('Menu classes after toggle:', menu.className);
  } else {
    console.error('Menu element not found!');
  }
};

// Language configuration and functions
(function() {
  // Language configuration from Jekyll
  var languages = [];
  {%- if site.languages and site.languages.size > 0 -%}
    {%- for lang in site.languages -%}
    languages.push({
      code: "{{ lang.code }}",
      name: "{{ lang.name }}",
      flag: "{{ lang.flag }}",
      path: "{{ lang.path }}"
    });
    {%- endfor -%}
  {%- else -%}
    // Fallback if languages not configured
    languages = [
      { code: "en", name: "English", flag: "ðŸ‡ºðŸ‡¸", path: "" },
      { code: "zh-cn", name: "ç®€ä½“ä¸­æ–‡", flag: "ðŸ‡¨ðŸ‡³", path: "zh-cn" }
    ];
  {%- endif -%}

  var basePath = '{{ site.baseurl }}' || '';
  // Normalize basePath
  if (basePath && basePath.charAt(basePath.length - 1) === '/') {
    basePath = basePath.slice(0, -1);
  }

  // Get current language from page or URL
  function getCurrentLanguage() {
    var currentPath = window.location.pathname;
    var relativePath = currentPath.replace(basePath, '');
    if (relativePath.charAt(0) !== '/') {
      relativePath = '/' + relativePath;
    }
    
    // Check if we're in a language-specific path
    for (var i = 0; i < languages.length; i++) {
      var lang = languages[i];
      if (lang.path && relativePath.indexOf('/' + lang.path + '/') === 0) {
        return lang.code;
      }
    }
    // Default to English
    return 'en';
  }

  // Convert path between languages
  function convertPath(currentPath, fromLang, toLang) {
    var relativePath = currentPath.replace(basePath, '');
    if (relativePath.charAt(0) !== '/') {
      relativePath = '/' + relativePath;
    }
    
    // Find language paths
    var fromLangObj = null;
    var toLangObj = null;
    for (var i = 0; i < languages.length; i++) {
      if (languages[i].code === fromLang) {
        fromLangObj = languages[i];
      }
      if (languages[i].code === toLang) {
        toLangObj = languages[i];
      }
    }
    
    if (!fromLangObj || !toLangObj) {
      return currentPath; // Fallback
    }

    // Remove current language prefix
    if (fromLangObj.path) {
      var langPrefix = '/' + fromLangObj.path;
      if (relativePath.indexOf(langPrefix) === 0) {
        relativePath = relativePath.substring(langPrefix.length);
      }
    }
    
    // Ensure relativePath starts with /
    if (relativePath.charAt(0) !== '/') {
      relativePath = '/' + relativePath;
    }
    
    // Add target language prefix
    if (toLangObj.path) {
      relativePath = '/' + toLangObj.path + relativePath;
    }

    // Handle index pages
    if (relativePath === '/' || relativePath === '') {
      if (toLangObj.path) {
        relativePath = '/' + toLangObj.path + '/';
      } else {
        relativePath = '/';
      }
    } else if (relativePath.charAt(relativePath.length - 1) === '/') {
      relativePath += 'index.html';
    } else if (relativePath.indexOf('.html') === -1 && relativePath !== '/') {
      relativePath += '.html';
    }

    var newPath = basePath + relativePath;
    return newPath;
  }

  // Switch to a specific language
  window.switchLanguage = function(langCode) {
    try {
      var currentLang = getCurrentLanguage();
      
      // Don't switch if already in target language
      if (currentLang === langCode) {
        return;
      }

      var currentPath = window.location.pathname;
      var newPath = convertPath(currentPath, currentLang, langCode);
      
      if (newPath && newPath !== currentPath) {
        window.location.href = newPath;
      }
    } catch (e) {
      console.error('Error switching language:', e);
    }
  };

  // toggleLanguageMenu is already defined at the top of the script

  // Initialize when DOM is ready
  function initLanguageToggle() {
    // Button click handler - use direct event binding
    var btn = document.getElementById('languageToggleBtn');
    if (btn) {
      // Remove any existing handlers
      btn.onclick = null;
      // Add click handler - use capture phase to ensure it fires first
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        e.preventDefault();
        console.log('Language button clicked');
        var menu = document.getElementById('languageMenu');
        if (menu) {
          var isShowing = menu.classList.contains('show');
          if (isShowing) {
            menu.classList.remove('show');
          } else {
            menu.classList.add('show');
          }
        }
        return false;
      }, true); // Capture phase - fires before other handlers
    } else {
      console.error('Language toggle button not found!');
    }

    // Language option click handlers - use event delegation
    document.addEventListener('click', function(e) {
      var option = e.target.closest('.language-option');
      if (option) {
        e.preventDefault();
        e.stopPropagation();
        var langCode = option.getAttribute('data-lang');
        if (langCode && window.switchLanguage) {
          window.switchLanguage(langCode);
        }
        // Close menu after selection
        var menu = document.getElementById('languageMenu');
        if (menu) {
          menu.classList.remove('show');
        }
        return false;
      }
    });

    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      var selector = document.querySelector('.language-selector');
      var menu = document.getElementById('languageMenu');
      var btn = document.getElementById('languageToggleBtn');
      // Don't close if clicking the button or menu items
      if (selector && menu && !selector.contains(event.target) && event.target !== btn) {
        menu.classList.remove('show');
      }
    }, true); // Use capture phase to handle before other handlers
  }

  // Wait for DOM - try multiple methods
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLanguageToggle);
  } else {
    initLanguageToggle();
  }
  
  // Also try after a short delay as fallback
  setTimeout(function() {
    var btn = document.getElementById('languageToggleBtn');
    if (btn && !btn.onclick) {
      console.log('Retrying language toggle init');
      initLanguageToggle();
    }
  }, 100);
})();
</script>

<div class="language-toggle">
  <div class="language-selector">
    {%- assign current_lang = "en" -%}
    {%- if page.url contains "/zh-cn/" -%}
      {%- assign current_lang = "zh-cn" -%}
    {%- elsif page.url contains "/es/" -%}
      {%- assign current_lang = "es" -%}
    {%- elsif page.lang -%}
      {%- assign current_lang = page.lang -%}
    {%- endif -%}
    {%- assign current_lang_obj = site.languages | where: "code", current_lang | first -%}
    {%- if current_lang_obj == nil -%}
      {%- assign current_lang_obj = site.languages | where: "code", "en" | first -%}
    {%- endif -%}
    
    <button id="languageToggleBtn" class="language-btn" type="button" aria-label="é€‰æ‹©è¯­è¨€ / Select Language" onclick="window.toggleLanguageMenu(); return false;">
      <span class="language-flag">{{ current_lang_obj.flag }}</span>
      <span class="language-name">{{ current_lang_obj.name }}</span>
      <svg class="language-arrow" viewBox="0 0 24 24" width="16" height="16">
        <path d="M7 10l5 5 5-5z" fill="currentColor"/>
      </svg>
    </button>
    
    <div class="language-menu" id="languageMenu">
      {%- for lang in site.languages -%}
        {%- if lang.code != current_lang -%}
        <a href="#" 
           data-lang="{{ lang.code }}"
           class="language-option">
          <span class="language-flag">{{ lang.flag }}</span>
          <span class="language-name">{{ lang.name }}</span>
        </a>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
</div>

<style>
.language-toggle {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 9999 !important;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.language-selector {
  position: relative;
  display: inline-block;
}

.language-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--body-background-color);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--body-text-color);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  white-space: nowrap;
  user-select: none;
  -webkit-user-select: none;
  pointer-events: auto;
  z-index: 1001;
}

.language-btn:hover {
  background: var(--sidebar-color);
  border-color: var(--link-color);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transform: translateY(-1px);
}

.language-btn:active {
  transform: translateY(0);
}

.language-flag {
  font-size: 18px;
  line-height: 1;
}

.language-name {
  font-size: 14px;
}

.language-arrow {
  margin-left: 4px;
  transition: transform 0.2s ease;
  opacity: 0.7;
}

.language-selector:hover .language-arrow {
  opacity: 1;
}

.language-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: var(--body-background-color);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 180px;
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1000;
  pointer-events: none;
}

.language-menu.show {
  max-height: 500px;
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.language-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  color: var(--body-text-color);
  text-decoration: none;
  transition: background-color 0.15s ease;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
}

.language-option:last-child {
  border-bottom: none;
}

.language-option:hover {
  background: var(--sidebar-color);
}

.language-option.active {
  background: var(--link-color);
  color: var(--body-background-color);
}

.language-option .language-flag {
  font-size: 20px;
  line-height: 1;
}

.language-option .language-name {
  font-size: 14px;
  font-weight: 500;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .language-toggle {
    top: 60px;
    right: 10px;
  }
  
  .language-btn {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .language-name {
    display: none; /* Hide text on mobile, show only flag */
  }
  
  .language-menu {
    min-width: 140px;
    right: 0;
  }
  
  .language-option .language-name {
    font-size: 13px;
    display: block; /* Show in menu */
  }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .language-menu {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
}
</style>
