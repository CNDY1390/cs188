<!-- Multi-Language Toggle -->
<script type="text/javascript">
(function() {
  // Language configuration from Jekyll
  var languages = [
    {%- for lang in site.languages -%}
    {
      code: "{{ lang.code }}",
      name: "{{ lang.name }}",
      flag: "{{ lang.flag }}",
      path: "{{ lang.path }}"
    }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ];

  var basePath = '{{ site.baseurl }}';

  // Get current language from page or URL
  function getCurrentLanguage() {
    var currentPath = window.location.pathname;
    var relativePath = currentPath.replace(basePath, '');
    
    // Check if we're in a language-specific path
    for (var i = 0; i < languages.length; i++) {
      var lang = languages[i];
      if (lang.path && relativePath.indexOf('/' + lang.path + '/') === 0) {
        return lang.code;
      }
    }
    // Default to English
    return 'en';
  }

  // Convert path between languages
  function convertPath(currentPath, fromLang, toLang) {
    var relativePath = currentPath.replace(basePath, '');
    
    // Find language paths
    var fromLangObj = languages.find(function(l) { return l.code === fromLang; });
    var toLangObj = languages.find(function(l) { return l.code === toLang; });
    
    if (!fromLangObj || !toLangObj) {
      return currentPath; // Fallback
    }

    // Remove current language prefix
    if (fromLangObj.path) {
      relativePath = relativePath.replace('/' + fromLangObj.path, '');
    }
    
    // Add target language prefix
    if (toLangObj.path) {
      relativePath = '/' + toLangObj.path + relativePath;
    } else {
      // English (root path)
      if (relativePath.charAt(0) !== '/') {
        relativePath = '/' + relativePath;
      }
    }

    // Handle index pages
    if (relativePath === '/' || relativePath === '') {
      relativePath = '/';
      if (toLangObj.path) {
        relativePath = '/' + toLangObj.path + '/';
      }
    } else if (relativePath.charAt(relativePath.length - 1) === '/') {
      relativePath += 'index.html';
    } else if (relativePath.indexOf('.html') === -1) {
      relativePath += '.html';
    }

    return basePath + relativePath;
  }

  // Switch to a specific language
  window.switchLanguage = function(langCode) {
    var currentLang = getCurrentLanguage();
    
    // Don't switch if already in target language
    if (currentLang === langCode) {
      return;
    }

    var currentPath = window.location.pathname;
    var newPath = convertPath(currentPath, currentLang, langCode);
    
    window.location.href = newPath;
  };

  // Expose for debugging
  window.getCurrentLanguage = getCurrentLanguage;
})();
</script>

<div class="language-toggle">
  <div class="language-selector">
    {%- assign current_lang = page.lang | default: "en" -%}
    {%- assign current_lang_obj = site.languages | where: "code", current_lang | first -%}
    {%- if current_lang_obj == nil -%}
      {%- assign current_lang_obj = site.languages | where: "code", "en" | first -%}
    {%- endif -%}
    
    <button class="language-btn" onclick="toggleLanguageMenu()" aria-label="选择语言 / Select Language">
      <span class="language-flag">{{ current_lang_obj.flag }}</span>
      <span class="language-name">{{ current_lang_obj.name }}</span>
      <svg class="language-arrow" viewBox="0 0 24 24" width="16" height="16">
        <path d="M7 10l5 5 5-5z" fill="currentColor"/>
      </svg>
    </button>
    
    <div class="language-menu" id="languageMenu">
      {%- for lang in site.languages -%}
        {%- if lang.code != current_lang -%}
        <a href="javascript:void(0)" 
           onclick="switchLanguage('{{ lang.code }}'); return false;" 
           class="language-option{% if lang.code == current_lang %} active{% endif %}">
          <span class="language-flag">{{ lang.flag }}</span>
          <span class="language-name">{{ lang.name }}</span>
        </a>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
</div>

<script>
function toggleLanguageMenu() {
  var menu = document.getElementById('languageMenu');
  menu.classList.toggle('show');
}

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  var selector = document.querySelector('.language-selector');
  var menu = document.getElementById('languageMenu');
  if (selector && menu && !selector.contains(event.target)) {
    menu.classList.remove('show');
  }
});
</script>

<style>
.language-toggle {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 999;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.language-selector {
  position: relative;
  display: inline-block;
}

.language-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--body-background-color);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--body-text-color);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  white-space: nowrap;
}

.language-btn:hover {
  background: var(--sidebar-color);
  border-color: var(--link-color);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transform: translateY(-1px);
}

.language-flag {
  font-size: 18px;
  line-height: 1;
}

.language-name {
  font-size: 14px;
}

.language-arrow {
  margin-left: 4px;
  transition: transform 0.2s ease;
  opacity: 0.7;
}

.language-selector:hover .language-arrow {
  opacity: 1;
}

.language-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: var(--body-background-color);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 180px;
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1000;
}

.language-menu.show {
  max-height: 500px;
  opacity: 1;
  transform: translateY(0);
}

.language-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  color: var(--body-text-color);
  text-decoration: none;
  transition: background-color 0.15s ease;
  border-bottom: 1px solid var(--border-color);
}

.language-option:last-child {
  border-bottom: none;
}

.language-option:hover {
  background: var(--sidebar-color);
}

.language-option.active {
  background: var(--link-color);
  color: var(--body-background-color);
}

.language-option .language-flag {
  font-size: 20px;
  line-height: 1;
}

.language-option .language-name {
  font-size: 14px;
  font-weight: 500;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .language-toggle {
    top: 60px;
    right: 10px;
  }
  
  .language-btn {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .language-name {
    display: none; /* Hide text on mobile, show only flag */
  }
  
  .language-menu {
    min-width: 140px;
    right: 0;
  }
  
  .language-option .language-name {
    font-size: 13px;
  }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .language-menu {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
}
</style>
