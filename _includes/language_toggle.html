<!-- Multi-Language Toggle -->
<script type="text/javascript">
(function() {
// Language configuration and functions defined globally
var languages = [];
{%- if site.languages and site.languages.size > 0 -%}
  {%- for lang in site.languages -%}
  languages.push({
    code: "{{ lang.code }}",
    name: "{{ lang.name }}",
    flag: "{{ lang.flag }}",
    path: "{{ lang.path }}"
  });
  {%- endfor -%}
{%- endif -%}

var basePath = '{{ site.baseurl }}' || '';
// Normalize basePath
if (basePath && basePath.charAt(basePath.length - 1) === '/') {
  basePath = basePath.slice(0, -1);
}

// Get current language from page or URL
function getCurrentLanguage() {
  var currentPath = window.location.pathname;
  var relativePath = currentPath.replace(basePath, '');
  if (relativePath.charAt(0) !== '/') {
    relativePath = '/' + relativePath;
  }
  
  // Check if we're in a language-specific path
  for (var i = 0; i < languages.length; i++) {
    var lang = languages[i];
    if (lang.path && relativePath.indexOf('/' + lang.path + '/') === 0) {
      return lang.code;
    }
  }
  // Default to English
  return 'en';
}

// Convert path between languages
function convertPath(currentPath, fromLang, toLang) {
  var relativePath = currentPath.replace(basePath, '');
  if (relativePath.charAt(0) !== '/') {
    relativePath = '/' + relativePath;
  }
  
  // Find language paths
  var fromLangObj = null;
  var toLangObj = null;
  for (var i = 0; i < languages.length; i++) {
    if (languages[i].code === fromLang) {
      fromLangObj = languages[i];
    }
    if (languages[i].code === toLang) {
      toLangObj = languages[i];
    }
  }
  
  if (!fromLangObj || !toLangObj) {
    return currentPath;
  }

  // Remove current language prefix
  if (fromLangObj.path) {
    var langPrefix = '/' + fromLangObj.path;
    if (relativePath.indexOf(langPrefix) === 0) {
      relativePath = relativePath.substring(langPrefix.length);
    }
  }
  
  // Ensure relativePath starts with /
  if (relativePath.charAt(0) !== '/') {
    relativePath = '/' + relativePath;
  }
  
  // Add target language prefix
  if (toLangObj.path) {
    relativePath = '/' + toLangObj.path + relativePath;
  }

  // Handle root path
  if (relativePath === '/' || relativePath === '') {
    if (toLangObj.path) {
      relativePath = '/' + toLangObj.path + '/';
    } else {
      relativePath = '/';
    }
  }

  var newPath = basePath + relativePath;
  return newPath;
}

// Switch to a specific language - make it global
window.switchLanguage = function(langCode) {
  try {
    console.log('switchLanguage called with:', langCode);
    var currentLang = getCurrentLanguage();
    console.log('Current language:', currentLang);
    
    // Don't switch if already in target language
    if (currentLang === langCode) {
      console.log('Already in target language');
      return;
    }

    var currentPath = window.location.pathname;
    console.log('Current path:', currentPath);
    var newPath = convertPath(currentPath, currentLang, langCode);
    console.log('New path:', newPath);
    
    if (newPath && newPath !== currentPath) {
      console.log('Redirecting to:', newPath);
      window.location.href = newPath;
    } else {
      console.error('Language switch failed:', {
        currentPath: currentPath,
        newPath: newPath,
        currentLang: currentLang,
        targetLang: langCode
      });
    }
  } catch (e) {
    console.error('Error in switchLanguage:', e);
  }
};

// Verify function is defined
console.log('switchLanguage defined:', typeof window.switchLanguage);

// Close menu when clicking outside
document.addEventListener('click', function(event) {
  var selector = document.querySelector('.language-selector');
  var menu = document.getElementById('languageMenu');
  var btn = document.getElementById('languageToggleBtn');
  var option = event.target.closest('.language-option');
  // Don't close if clicking the button, menu items, or language options
  if (selector && menu && !selector.contains(event.target) && event.target !== btn && !option) {
    menu.classList.remove('show');
  }
}, true); // Use capture phase to handle before other handlers
})();
</script>

<div class="language-toggle">
  <div class="language-selector">
    {%- assign current_lang = "en" -%}
    {%- if page.url contains "/zh-cn/" -%}
      {%- assign current_lang = "zh-cn" -%}
    {%- elsif page.url contains "/es/" -%}
      {%- assign current_lang = "es" -%}
    {%- elsif page.lang -%}
      {%- assign current_lang = page.lang -%}
    {%- endif -%}
    {%- assign current_lang_obj = site.languages | where: "code", current_lang | first -%}
    {%- if current_lang_obj == nil -%}
      {%- assign current_lang_obj = site.languages | where: "code", "en" | first -%}
    {%- endif -%}
    
    <button id="languageToggleBtn" class="language-btn" type="button" aria-label="选择语言 / Select Language" onclick="(function(){var m=document.getElementById('languageMenu');if(m){m.classList.toggle('show');}return false;})();return false;">
      <span class="language-flag">{{ current_lang_obj.flag }}</span>
      <span class="language-name">{{ current_lang_obj.name }}</span>
      <svg class="language-arrow" viewBox="0 0 24 24" width="16" height="16">
        <path d="M7 10l5 5 5-5z" fill="currentColor"/>
      </svg>
    </button>
    
    <div class="language-menu" id="languageMenu">
      {%- for lang in site.languages -%}
        {%- if lang.code != current_lang -%}
        <a href="#" 
           data-lang="{{ lang.code }}"
           class="language-option"
           onclick="if(typeof window.switchLanguage==='function'){window.switchLanguage('{{ lang.code }}');}else{console.error('switchLanguage not defined');}return false;">
          <span class="language-flag">{{ lang.flag }}</span>
          <span class="language-name">{{ lang.name }}</span>
        </a>
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>
</div>

<style>
.language-toggle {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 9999 !important;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.language-selector {
  position: relative;
  display: inline-block;
}

.language-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--body-background-color);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  color: var(--body-text-color);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  white-space: nowrap;
  user-select: none;
  -webkit-user-select: none;
  pointer-events: auto;
  z-index: 1001;
}

.language-btn:hover {
  background: var(--sidebar-color);
  border-color: var(--link-color);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transform: translateY(-1px);
}

.language-btn:active {
  transform: translateY(0);
}

.language-flag {
  font-size: 18px;
  line-height: 1;
}

.language-name {
  font-size: 14px;
}

.language-arrow {
  margin-left: 4px;
  transition: transform 0.2s ease;
  opacity: 0.7;
}

.language-selector:hover .language-arrow {
  opacity: 1;
}

.language-menu {
  position: absolute;
  top: calc(100% + 8px);
  right: 0;
  background: var(--body-background-color);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  min-width: 180px;
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.2s ease;
  z-index: 1000;
  pointer-events: none;
}

.language-menu.show {
  max-height: 500px;
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.language-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  color: var(--body-text-color);
  text-decoration: none;
  transition: background-color 0.15s ease;
  border-bottom: 1px solid var(--border-color);
  cursor: pointer;
}

.language-option:last-child {
  border-bottom: none;
}

.language-option:hover {
  background: var(--sidebar-color);
}

.language-option.active {
  background: var(--link-color);
  color: var(--body-background-color);
}

.language-option .language-flag {
  font-size: 20px;
  line-height: 1;
}

.language-option .language-name {
  font-size: 14px;
  font-weight: 500;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .language-toggle {
    top: 60px;
    right: 10px;
  }
  
  .language-btn {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .language-name {
    display: none; /* Hide text on mobile, show only flag */
  }
  
  .language-menu {
    min-width: 140px;
    right: 0;
  }
  
  .language-option .language-name {
    font-size: 13px;
    display: block; /* Show in menu */
  }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
  .language-menu {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
}
</style>
